# AI角色扮演平台架构设计文档

## 1. 概述

AI角色扮演平台是一个前后端分离的Web应用程序，允许用户与不同的AI角色进行文本和语音交互。该平台提供了角色管理、对话历史记录、语音识别(ASR)和文本转语音(TTS)等功能。

## 2. 技术架构

### 2.1 整体架构图

> **注意**: 如果您看不到下面的架构图，说明您的Markdown查看器不支持Mermaid渲染。请安装支持Mermaid的编辑器（如VS Code配合Mermaid插件）或查看项目根目录下的架构图图片文件。

``mermaid
graph TB
    A[用户浏览器] --> B(前端应用<br/>React + Vite<br/>端口:3000/3001)
    B --> C(后端服务<br/>Spring Boot<br/>端口:8082)
    C --> D[(数据库)]
    C --> E[七牛云服务]
    E --> F[ASR语音识别]
    E --> G[TTS文本转语音]
    E --> H[OSS对象存储]
    
    style A fill:#FFE4C4,stroke:#333
    style B fill:#87CEEB,stroke:#333
    style C fill:#98FB98,stroke:#333
    style D fill:#FFA07A,stroke:#333
    style E fill:#DDA0DD,stroke:#333
    style F fill:#FFD700,stroke:#333
    style G fill:#FFD700,stroke:#333
    style H fill:#FFD700,stroke:#333
```

### 2.2 前端架构图

``mermaid
graph TD
    A[App组件] --> B[角色列表组件]
    A --> C[对话组件]
    A --> D[角色管理组件]
    C --> E[语音输入模块]
    C --> F[语音输出模块]
    C --> G[消息显示模块]
    
    style A fill:#87CEEB,stroke:#333
    style B fill:#98FB98,stroke:#333
    style C fill:#98FB98,stroke:#333
    style D fill:#98FB98,stroke:#333
    style E fill:#FFD700,stroke:#333
    style F fill:#FFD700,stroke:#333
    style G fill:#FFD700,stroke:#333
```

### 2.3 后端架构图

``mermaid
graph TD
    A[Spring Boot应用] --> B[Controller层]
    A --> C[Service层]
    A --> D[Repository层]
    A --> E[Config配置层]
    B --> F[CharacterController]
    B --> G[ChatMessageController]
    B --> H[AsrController]
    B --> I[TtsController]
    C --> J[CharacterService]
    C --> K[ChatMessageService]
    C --> L[QiniuAsrService]
    C --> M[QiniuTtsService]
    D --> N[CharacterRepository]
    D --> O[ChatMessageRepository]
    E --> P[Qiniu配置类]
    
    style A fill:#98FB98,stroke:#333
    style B fill:#87CEEB,stroke:#333
    style C fill:#87CEEB,stroke:#333
    style D fill:#87CEEB,stroke:#333
    style E fill:#87CEEB,stroke:#333
    style F fill:#FFD700,stroke:#333
    style G fill:#FFD700,stroke:#333
    style H fill:#FFD700,stroke:#333
    style I fill:#FFD700,stroke:#333
    style J fill:#FFD700,stroke:#333
    style K fill:#FFD700,stroke:#333
    style L fill:#FFD700,stroke:#333
    style M fill:#FFD700,stroke:#333
    style N fill:#FFD700,stroke:#333
    style O fill:#FFD700,stroke:#333
    style P fill:#FFD700,stroke:#333
```

### 2.4 端口配置
- **前端**: 3001端口（3000端口被占用时）
- **后端**: 8082端口
- **跨域处理**: 通过前端代理解决跨域问题

## 3. 前端架构

### 3.1 技术栈
- React 17+
- Vite构建工具
- CSS3 + Flexbox布局
- Web Speech API (浏览器原生TTS)
- MediaRecorder API (录音)

### 3.2 主要组件
- App组件: 主应用组件，包含路由和状态管理
- 角色列表组件: 显示可用的AI角色
- 对话组件: 处理用户与AI角色的对话
- 角色管理组件: 添加/删除角色功能

### 3.3 状态管理
- React Hooks (useState, useEffect, useRef)
- 组件内状态管理，无额外状态管理库

## 4. 后端架构

### 4.1 技术栈
- Spring Boot 2.5+
- Java 8+
- Maven构建工具
- JPA/Hibernate (如使用)
- RESTful API设计

### 4.2 主要模块规格

#### 4.2.1 角色管理模块 (Character Management)
- **功能描述**: 管理AI角色的增删改查
- **主要类**:
  - `Character`: 角色实体类
  - `CharacterRepository`: 角色数据访问接口
  - `CharacterService`: 角色业务逻辑处理
  - `CharacterController`: 角色HTTP接口控制器
- **API接口**:
  - `GET /api/characters` - 获取所有角色
  - `POST /api/characters` - 创建新角色
  - `DELETE /api/characters/{id}` - 删除角色
  - `GET /api/characters/search` - 搜索角色

#### 4.2.2 对话管理模块 (Chat Management)
- **功能描述**: 处理用户与AI角色的对话消息
- **主要类**:
  - `ChatMessage`: 对话消息实体类
  - `ChatMessageRepository`: 对话消息数据访问接口
  - `ChatMessageService`: 对话消息业务逻辑处理
  - `ChatMessageController`: 对话消息HTTP接口控制器
- **API接口**:
  - `GET /api/chat/history/{characterId}` - 获取对话历史
  - `POST /api/chat/send` - 发送消息

#### 4.2.3 语音识别模块 (ASR - Automatic Speech Recognition)
- **功能描述**: 处理语音转文本功能
- **主要类**:
  - `QiniuAsrService`: 七牛云ASR服务实现
  - `AsrController`: ASR HTTP接口控制器
- **API接口**:
  - `POST /api/asr/transcribe` - 语音转文本

#### 4.2.4 文本转语音模块 (TTS - Text To Speech)
- **功能描述**: 处理文本转语音功能
- **主要类**:
  - `QiniuTtsService`: 七牛云TTS服务实现
  - `TtsController`: TTS HTTP接口控制器
- **API接口**:
  - `POST /api/tts/speak` - 文本转语音

#### 4.2.5 配置管理模块 (Configuration Management)
- **功能描述**: 管理七牛云等第三方服务配置
- **主要类**:
  - `QiniuAIConfig`: 七牛云AI服务配置
  - `QiniuASRConfig`: 七牛云ASR配置
  - `QiniuTTSConfig`: 七牛云TTS配置
  - `QiniuOSSConfig`: 七牛云OSS配置

## 5. 数据库设计

### 5.1 角色表 (Character)
| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | Long | 主键 |
| name | String | 角色名称 |
| description | String | 角色描述 |
| personalityTraits | String | 性格特征 |
| backgroundStory | String | 背景故事 |
| voiceType | String | 音色类型 |

### 5.2 对话记录表 (ChatMessage)
| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | Long | 主键 |
| characterId | Long | 关联角色ID |
| message | String | 消息内容 |
| isUserMessage | Boolean | 是否为用户消息 |
| createdAt | LocalDateTime | 创建时间 |

## 6. 语音功能设计

### 6.1 语音识别 (ASR)
- 前端使用MediaRecorder API录制音频
- 音频文件上传至后端ASR服务
- 后端调用七牛云ASR服务进行语音转文本

### 6.2 文本转语音 (TTS)
- 后端调用七牛云TTS服务生成音频
- 音频数据返回给前端播放
- 前端使用Web Speech API作为备选方案

## 7. 部署架构

### 7.1 开发环境
- 前端: `npm run dev` 运行在localhost:3001
- 后端: `mvn spring-boot:run` 运行在localhost:8082

### 7.2 生产环境
- 前端: 构建后部署到Nginx或CDN
- 后端: 打包为jar文件，通过java -jar运行
- 数据库: 独立部署或使用云服务

## 8. 安全设计

### 8.1 API安全
- CORS配置
- 请求验证和过滤

### 8.2 数据安全
- 敏感信息加密存储
- 数据传输使用HTTPS

## 9. 性能优化

### 9.1 前端优化
- 代码分割和懒加载
- 虚拟滚动处理大量对话记录
- 缓存角色信息

### 9.2 后端优化
- 数据库索引优化
- API响应缓存
- 异步处理耗时操作

## 10. 扩展性设计

### 10.1 微服务扩展
- 可将ASR/TTS服务拆分为独立服务
- 角色管理服务独立部署

### 10.2 多租户支持
- 支持多用户和角色隔离
- 权限控制机制

---
*文档版本: 1.0*
*最后更新: 2025-09-28*