# è§’è‰²éŸ³è‰²åŒ¹é…å®Œæ•´å®ç°æ–¹æ¡ˆ

## æ¦‚è¿°
æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†å¦‚ä½•åœ¨AIè§’è‰²æ‰®æ¼”å¹³å°ä¸­å®ç°æ ¹æ®è§’è‰²ç‰¹å¾è‡ªåŠ¨åŒ¹é…ä¸ƒç‰›äº‘TTSéŸ³è‰²çš„åŠŸèƒ½ã€‚é€šè¿‡æ­¤åŠŸèƒ½ï¼Œæ¯ä¸ªè§’è‰²éƒ½å¯ä»¥æ‹¥æœ‰ä¸å…¶æ€§æ ¼ç‰¹å¾ã€èƒŒæ™¯æ•…äº‹ç›¸åŒ¹é…çš„ç‹¬ç‰¹éŸ³è‰²ï¼Œä»è€Œæå‡ç”¨æˆ·ä½“éªŒå’Œæ²‰æµ¸æ„Ÿã€‚

## åŠŸèƒ½å®ç°

### 1. åç«¯å®ç°

#### 1.1 æ•°æ®åº“æ¨¡å‹æ›´æ–°
åœ¨`Character`å®ä½“ç±»ä¸­æ·»åŠ äº†`voiceType`å­—æ®µï¼Œç”¨äºå­˜å‚¨æ¯ä¸ªè§’è‰²çš„éŸ³è‰²è®¾ç½®ï¼š

```java
@Entity
@Table(name = "characters")
public class Character {
    // ... å…¶ä»–å­—æ®µ ...
    
    @Column(name = "voice_type")
    private String voiceType;
    
    // ... getters and setters ...
}
```

#### 1.2 æ•°æ®è®¿é—®å±‚æ›´æ–°
åœ¨`CharacterRepository`ä¸­æ·»åŠ äº†æ–°çš„æŸ¥è¯¢æ–¹æ³•ï¼Œæ”¯æŒæŒ‰åç§°ã€æè¿°ã€æ€§æ ¼ç‰¹å¾æˆ–èƒŒæ™¯æ•…äº‹è¿›è¡Œæœç´¢ï¼š

```java
public interface CharacterRepository extends JpaRepository<Character, Long> {
    List<Character> findByNameContainingOrDescriptionContainingOrPersonalityTraitsContainingOrBackgroundStoryContainingAllIgnoreCase(
        String name, String description, String personalityTraits, String backgroundStory);
}
```

#### 1.3 æ§åˆ¶å™¨å±‚æ›´æ–°
åœ¨`CharacterController`ä¸­æ·»åŠ äº†è·å–éŸ³è‰²åˆ—è¡¨çš„APIç«¯ç‚¹ï¼š

```java
@GetMapping("/voices")
public ResponseEntity<?> getVoiceList() {
    try {
        // è¿”å›é¢„å®šä¹‰çš„éŸ³è‰²åˆ—è¡¨
        Map<String, String>[] voices = new Map[]{
            createVoiceMap("æ¸©å©‰å­¦ç§‘è®²å¸ˆ", "qiniu_zh_female_wwxkjx"),
            createVoiceMap("ç”œç¾æ•™å­¦å°æº", "qiniu_zh_female_tmjxxy"),
            // ... å…¶ä»–éŸ³è‰² ...
        };
        
        return ResponseEntity.ok(voices);
    } catch (Exception e) {
        return ResponseEntity.status(500).body("è·å–éŸ³è‰²åˆ—è¡¨å¤±è´¥: " + e.getMessage());
    }
}
```

åœ¨åˆ›å»ºè§’è‰²æ—¶ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šéŸ³è‰²ï¼Œåˆ™è‡ªåŠ¨åˆ†é…é»˜è®¤éŸ³è‰²ï¼š

```java
@PostMapping
public Character createCharacter(@RequestBody Character character) {
    // å¦‚æœæ²¡æœ‰æŒ‡å®šéŸ³è‰²ï¼Œåˆ™è®¾ç½®é»˜è®¤éŸ³è‰²
    if (character.getVoiceType() == null || character.getVoiceType().isEmpty()) {
        character.setVoiceType("qiniu_zh_female_wwxkjx"); // é»˜è®¤éŸ³è‰²
    }
    return characterRepository.save(character);
}
```

#### 1.4 TTSæœåŠ¡æ›´æ–°
åœ¨`TtsController`ä¸­æ›´æ–°äº†è¯­éŸ³åˆæˆæ¥å£ï¼Œæ”¯æŒä½¿ç”¨è§’è‰²ç‰¹å®šéŸ³è‰²ï¼š

```java
@PostMapping(value = "/speak", consumes = MediaType.APPLICATION_JSON_VALUE)
public ResponseEntity<byte[]> speak(@RequestBody Map<String, String> request) {
    String text = request.get("text");
    String voice = request.get("voice"); // è§’è‰²ç‰¹å®šéŸ³è‰²
    String format = request.get("format");
    
    // å¦‚æœæ²¡æœ‰æŒ‡å®šéŸ³è‰²ï¼Œä½¿ç”¨é»˜è®¤éŸ³è‰²
    if (voice == null || voice.isEmpty()) {
        voice = "qiniu_zh_female_wwxkjx"; // é»˜è®¤éŸ³è‰²
    }
    
    byte[] audioBytes = ttsService.synthesize(text, voice, format);
    // ... è¿”å›éŸ³é¢‘æ•°æ® ...
}
```

### 2. å‰ç«¯å®ç°

#### 2.1 è§’è‰²åˆ›å»ºè¡¨å•æ›´æ–°
åœ¨è§’è‰²åˆ›å»ºè¡¨å•ä¸­æ·»åŠ äº†éŸ³è‰²é€‰æ‹©åŠŸèƒ½ï¼š

```jsx
<div>
    <select
        name="voiceType"
        value={newCharacter.voiceType}
        onChange={handleInputChange}
    >
        <option value="">è‡ªåŠ¨æ¨èéŸ³è‰²</option>
        <option value="qiniu_zh_female_wwxkjx">æ¸©å©‰å­¦ç§‘è®²å¸ˆ</option>
        <option value="qiniu_zh_female_tmjxxy">ç”œç¾æ•™å­¦å°æº</option>
        {/* ... å…¶ä»–éŸ³è‰²é€‰é¡¹ ... */}
    </select>
    {newCharacter.voiceType && (
        <button type="button" onClick={() => previewVoice(newCharacter.voiceType)}>
            è¯•å¬éŸ³è‰²
        </button>
    )}
    {!newCharacter.voiceType && (
        <button type="button" onClick={() => previewVoice(recommendVoice())}>
            è¯•å¬æ¨èéŸ³è‰²
        </button>
    )}
</div>
```

#### 2.2 éŸ³è‰²æ¨èç®—æ³•
å®ç°äº†åŸºäºè§’è‰²ç‰¹å¾çš„éŸ³è‰²æ¨èç®—æ³•ï¼š

```javascript
const recommendVoice = () => {
    const { description, personalityTraits, backgroundStory } = newCharacter;
    const characterText = `${description} ${personalityTraits} ${backgroundStory}`.toLowerCase();
    
    // ç®€å•çš„å…³é”®è¯åŒ¹é…é€»è¾‘
    if (characterText.includes("è€å¸ˆ") || characterText.includes("æ•™å¸ˆ") || characterText.includes("è®²å¸ˆ")) {
        return "qiniu_zh_female_wwxkjx"; // æ¸©å©‰å­¦ç§‘è®²å¸ˆ
    }
    if (characterText.includes("å­¦ç”Ÿ") || characterText.includes("å­¦é•¿") || characterText.includes("å­¦å§") || characterText.includes("æ ¡å›­")) {
        return "qiniu_zh_female_xyqxxj"; // æ ¡å›­æ¸…æ–°å­¦å§
    }
    // ... å…¶ä»–åŒ¹é…è§„åˆ™ ...
    
    // é»˜è®¤éŸ³è‰²
    return "qiniu_zh_female_wwxkjx";
};
```

#### 2.3 éŸ³è‰²é¢„è§ˆåŠŸèƒ½
å®ç°äº†éŸ³è‰²é¢„è§ˆåŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥åœ¨é€‰æ‹©éŸ³è‰²å‰è¯•å¬æ•ˆæœï¼š

```javascript
const previewVoice = async (voiceType) => {
    if (!voiceType) return;
    
    try {
        const text = "ä½ å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„AIåŠ©æ‰‹";
        const resp = await fetch(`http://localhost:8082/api/tts/speak`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                text: text,
                voice: voiceType,
                format: 'mp3'
            })
        });
        
        // æ’­æ”¾è¿”å›çš„éŸ³é¢‘
        const arrayBuffer = await resp.arrayBuffer();
        const blob = new Blob([arrayBuffer], { type: 'audio/mpeg' });
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        audio.onended = () => URL.revokeObjectURL(url);
        audio.onerror = () => URL.revokeObjectURL(url);
        await audio.play();
    } catch (e) {
        console.error('éŸ³è‰²é¢„è§ˆå¤±è´¥:', e);
        alert('éŸ³è‰²é¢„è§ˆå¤±è´¥');
    }
};
```

#### 2.4 è§’è‰²å¯¹è¯ä¸­çš„éŸ³è‰²ä½¿ç”¨
åœ¨è§’è‰²å¯¹è¯ä¸­ä½¿ç”¨è§’è‰²ç‰¹å®šçš„éŸ³è‰²è¿›è¡Œè¯­éŸ³æ’­æ”¾ï¼š

```javascript
<button
    className="voice-button"
    onClick={() => playVoice(msg.message, selectedCharacter.voiceType)}
    title={isSpeaking ? "åœæ­¢æ’­æ”¾" : "æ’­æ”¾è¯­éŸ³"}
    disabled={!msg.message.trim}
>
    {isSpeaking ? "â¹ï¸" : "ğŸ”Š"}
</button>
```

```javascript
const playVoice = async (message, characterVoiceType) => {
    // ä½¿ç”¨è§’è‰²ç‰¹å®šéŸ³è‰²è°ƒç”¨åç«¯TTSæœåŠ¡
    const resp = await fetch(`http://localhost:8082/api/tts/speak`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            text: message,
            voice: characterVoiceType, // ä½¿ç”¨è§’è‰²ç‰¹å®šéŸ³è‰²
            format: 'mp3'
        })
    });
    // ... æ’­æ”¾éŸ³é¢‘ ...
};
```

## éŸ³è‰²åŒ¹é…è§„åˆ™

### å…³é”®è¯åŒ¹é…è§„åˆ™
æ ¹æ®è§’è‰²æè¿°ä¸­çš„å…³é”®è¯è‡ªåŠ¨åŒ¹é…æœ€åˆé€‚çš„éŸ³è‰²ï¼š

1. **æ•™å¸ˆ/è®²å¸ˆç›¸å…³**ï¼šåŒ¹é…"æ¸©å©‰å­¦ç§‘è®²å¸ˆ"æˆ–"æ¸Šåšå­¦ç§‘ç”·æ•™å¸ˆ"éŸ³è‰²
2. **å­¦ç”Ÿ/æ ¡å›­ç›¸å…³**ï¼šåŒ¹é…"æ ¡å›­æ¸…æ–°å­¦å§"æˆ–"é‚»å®¶è¾…å¯¼å­¦é•¿"éŸ³è‰²
3. **æ€§æ ¼ç‰¹å¾åŒ¹é…**ï¼š
   - æ¸©å’Œã€çŸ¥æ€§ï¼šåŒ¹é…"ç”œç¾æ•™å­¦å°æº"
   - å¹´è½»ã€æ´»æ³¼ï¼šåŒ¹é…"é‚»å®¶è¾…å¯¼å­¦é•¿"
   - æˆç†Ÿã€ç¨³é‡ï¼šåŒ¹é…"æ¸©æš–æ²‰ç¨³å­¦é•¿"

### é»˜è®¤éŸ³è‰²
å¦‚æœæ— æ³•é€šè¿‡å…³é”®è¯åŒ¹é…ç¡®å®šéŸ³è‰²ï¼Œåˆ™ä½¿ç”¨"æ¸©å©‰å­¦ç§‘è®²å¸ˆ"ä½œä¸ºé»˜è®¤éŸ³è‰²ã€‚

## APIæ¥å£

### 1. è·å–éŸ³è‰²åˆ—è¡¨
```
GET /api/characters/voices
```
è¿”å›æ‰€æœ‰å¯ç”¨çš„éŸ³è‰²åˆ—è¡¨ã€‚

### 2. åˆ›å»ºè§’è‰²
```
POST /api/characters
```
åˆ›å»ºæ–°è§’è‰²ï¼Œæ”¯æŒæŒ‡å®šéŸ³è‰²ç±»å‹ã€‚

### 3. è¯­éŸ³åˆæˆ
```
POST /api/tts/speak
```
å°†æ–‡æœ¬è½¬æ¢ä¸ºè¯­éŸ³ï¼Œæ”¯æŒæŒ‡å®šéŸ³è‰²ç±»å‹ã€‚

## æµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•
1. åˆ›å»ºä¸åŒç‰¹å¾çš„è§’è‰²å¹¶éªŒè¯éŸ³è‰²æ¨èæ˜¯å¦åˆç†
2. æ‰‹åŠ¨é€‰æ‹©ä¸åŒéŸ³è‰²å¹¶é¢„è§ˆæ•ˆæœ
3. åœ¨è§’è‰²å¯¹è¯ä¸­éªŒè¯è¯­éŸ³æ’­æ”¾ä½¿ç”¨æ­£ç¡®çš„éŸ³è‰²
4. æµ‹è¯•æœªæŒ‡å®šéŸ³è‰²æ—¶çš„é»˜è®¤éŸ³è‰²åˆ†é…

### å…¼å®¹æ€§æµ‹è¯•
1. éªŒè¯åœ¨åç«¯TTSæœåŠ¡ä¸å¯ç”¨æ—¶å›é€€åˆ°æµè§ˆå™¨TTS
2. æµ‹è¯•ä¸åŒæµè§ˆå™¨çš„è¯­éŸ³æ’­æ”¾å…¼å®¹æ€§
3. éªŒè¯éŸ³è‰²é¢„è§ˆåŠŸèƒ½åœ¨å„ç§ç½‘ç»œæ¡ä»¶ä¸‹çš„è¡¨ç°

## æ€»ç»“
é€šè¿‡ä»¥ä¸Šå®ç°ï¼ŒAIè§’è‰²æ‰®æ¼”å¹³å°ç°åœ¨æ”¯æŒï¼š
1. æ ¹æ®è§’è‰²ç‰¹å¾è‡ªåŠ¨æ¨èåˆé€‚çš„éŸ³è‰²
2. æ‰‹åŠ¨é€‰æ‹©å’Œé¢„è§ˆéŸ³è‰²
3. åœ¨è§’è‰²å¯¹è¯ä¸­ä½¿ç”¨è§’è‰²ç‰¹å®šçš„éŸ³è‰²
4. åœ¨TTSæœåŠ¡ä¸å¯ç”¨æ—¶å›é€€åˆ°æµè§ˆå™¨TTS

è¿™äº›åŠŸèƒ½å¤§å¤§æå‡äº†ç”¨æˆ·ä½“éªŒï¼Œä½¿æ¯ä¸ªè§’è‰²éƒ½æ‹¥æœ‰ç‹¬ç‰¹çš„å£°éŸ³ç‰¹å¾ï¼Œå¢å¼ºäº†è§’è‰²æ‰®æ¼”çš„æ²‰æµ¸æ„Ÿã€‚