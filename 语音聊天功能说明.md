# 语音聊天功能说明

## 功能概述

本项目新增了语音聊天功能，用户可以通过语音与AI角色进行对话。整个流程如下：

1. 用户通过麦克风录制语音或上传音频文件
2. 系统将语音发送到七牛云ASR服务进行语音转文本
3. 将转换后的文本发送给AI模型生成回复
4. 返回AI回复给前端显示

## API接口

### 1. 语音聊天接口

**URL**: `POST /api/voice-chat/send-voice`

**描述**: 接收语音文件，转换为文本并获取AI回复

**参数**:
- `file` (MultipartFile): 音频文件
- `characterId` (Long): 角色ID

**响应**:
```json
{
  "success": true,
  "transcribedText": "转换后的文本",
  "userMessage": {
    "id": 1,
    "characterId": 1,
    "message": "转换后的文本",
    "isUserMessage": true,
    "createdAt": "2023-01-01T00:00:00"
  },
  "aiMessage": {
    "id": 2,
    "characterId": 1,
    "message": "AI回复内容",
    "isUserMessage": false,
    "createdAt": "2023-01-01T00:00:01"
  }
}
```

### 2. 语音测试接口

**URL**: `POST /api/voice-test/transcribe`

**描述**: 测试ASR服务是否正常工作

**参数**:
- `file` (MultipartFile): 音频文件

**响应**:
```json
{
  "success": true,
  "transcribedText": "转换后的文本"
}
```

## 前端集成

前端已经集成了语音输入功能，用户可以通过点击麦克风按钮开始录音，停止录音后系统会自动将语音转换为文本并发送给AI。

## 测试方法

### 1. 使用测试页面

打开 `test/voice-chat-test.html` 文件，可以通过以下方式测试：

1. 点击"开始录音"按钮，允许浏览器访问麦克风
2. 说话几秒钟
3. 点击"停止录音"按钮
4. 系统会自动处理语音并显示转换结果和AI回复

### 2. 使用curl命令测试

```bash
# 测试ASR服务
curl -X POST http://localhost:8082/api/asr/transcribe \
  -F "file=@/path/to/your/audio.mp3"

# 测试语音聊天功能
curl -X POST http://localhost:8082/api/voice-chat/send-voice \
  -F "file=@/path/to/your/audio.mp3" \
  -F "characterId=1"
```

## 配置说明

### ASR配置

在 `application.properties` 文件中配置ASR服务：

```properties
# Qiniu ASR Configuration (Speech-to-Text)
asr.qiniu.api-key=your_asr_api_key
asr.qiniu.base-url=https://openai.qiniu.com/v1
asr.qiniu.model=asr
```

## 错误处理

1. 如果ASR服务返回错误，系统会返回相应的错误信息
2. 如果AI服务不可用，系统会生成错误消息并保存到聊天记录中
3. 如果语音文件无法识别，系统会提示用户重新录制

## 支持的音频格式

- wav
- mp3
- ogg
- webm
- m4a
- aac
- flac

系统会自动检测上传文件的格式并进行相应处理。